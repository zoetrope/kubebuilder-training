
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>CRDマニフェストの生成 · つくって学ぶKubebuilder</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 5.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="rbac.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    つくって学ぶKubebuilder
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../introduction/installation.html">
            
                <a href="../introduction/installation.html">
            
                    
                    インストール
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="../introduction/basics.html">
            
                <a href="../introduction/basics.html">
            
                    
                    カスタムコントローラーの基礎
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="../introduction/sample.html">
            
                <a href="../introduction/sample.html">
            
                    
                    MarkdownViewコントローラー
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="../introduction/references.html">
            
                <a href="../introduction/references.html">
            
                    
                    参考情報
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../kubebuilder/">
            
                <a href="../kubebuilder/">
            
                    
                    Kubebuilder
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../kubebuilder/new-project.html">
            
                <a href="../kubebuilder/new-project.html">
            
                    
                    プロジェクトの雛形作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../kubebuilder/api.html">
            
                <a href="../kubebuilder/api.html">
            
                    
                    APIの雛形作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../kubebuilder/webhook.html">
            
                <a href="../kubebuilder/webhook.html">
            
                    
                    Webhookの雛形作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../kubebuilder/kind.html">
            
                <a href="../kubebuilder/kind.html">
            
                    
                    カスタムコントローラーの動作確認
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../kubebuilder/release.html">
            
                <a href="../kubebuilder/release.html">
            
                    
                    カスタムコントローラーのリリース
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    controller-tools
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.3.1" data-path="crd.html">
            
                <a href="crd.html">
            
                    
                    CRDマニフェストの生成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="rbac.html">
            
                <a href="rbac.html">
            
                    
                    RBACマニフェストの生成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="webhook.html">
            
                <a href="webhook.html">
            
                    
                    Webhookマニフェストの生成
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../controller-runtime/">
            
                <a href="../controller-runtime/">
            
                    
                    controller-runtime
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../controller-runtime/client.html">
            
                <a href="../controller-runtime/client.html">
            
                    
                    クライアントの使い方
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../controller-runtime/test.html">
            
                <a href="../controller-runtime/test.html">
            
                    
                    テスト
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../controller-runtime/reconcile.html">
            
                <a href="../controller-runtime/reconcile.html">
            
                    
                    Reconcileの実装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../controller-runtime/controller_test.html">
            
                <a href="../controller-runtime/controller_test.html">
            
                    
                    コントローラーのテスト(Envtest)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../controller-runtime/webhook.html">
            
                <a href="../controller-runtime/webhook.html">
            
                    
                    Webhookの実装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../controller-runtime/webhook_test.html">
            
                <a href="../controller-runtime/webhook_test.html">
            
                    
                    Webhookのテスト(Envtest)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../controller-runtime/deletion.html">
            
                <a href="../controller-runtime/deletion.html">
            
                    
                    リソースの削除
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../controller-runtime/manager.html">
            
                <a href="../controller-runtime/manager.html">
            
                    
                    Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../controller-runtime/monitoring.html">
            
                <a href="../controller-runtime/monitoring.html">
            
                    
                    モニタリング
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CRDマニフェストの生成</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="crdマニフェストの生成">CRDマニフェストの生成</h1>
<p>コントローラーでカスタムリソースを扱うためには、そのリソースのCRD(Custom Resource Definition)を定義する必要があります。
CRDのマニフェストは複雑で、手書きで作成するにはかなりの手間がかかります。</p>
<p>そこでKubebuilderではcontroller-genというツールを提供しており、Goで記述したstructからCRDを生成できます。</p>
<p>まずは<code>kubebuilder create api</code>コマンドで生成された<code>api/v1/markdownview_types.go</code>を見てみましょう。</p>
<blockquote>
<p><a id="markdownview_types.go" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/00_scaffold/api/v1/markdownview_types.go" target="_blank">markdownview_types.go</a></p>
</blockquote>
<pre><code class="lang-golang"><span class="hljs-comment">/*
Copyright 2024.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</span>

<span class="hljs-keyword">package</span> v1

<span class="hljs-keyword">import</span> (
    metav1 <span class="hljs-string">"k8s.io/apimachinery/pkg/apis/meta/v1"</span>
)

<span class="hljs-comment">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!</span>
<span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> json tags are required.  Any new fields you add must have json tags for the fields to be serialized.</span>

<span class="hljs-comment">// MarkdownViewSpec defines the desired state of MarkdownView</span>
<span class="hljs-keyword">type</span> MarkdownViewSpec <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
    <span class="hljs-comment">// Important: Run "make" to regenerate code after modifying this file</span>

    <span class="hljs-comment">// Foo is an example field of MarkdownView. Edit markdownview_types.go to remove/update</span>
    Foo <span class="hljs-type">string</span> <span class="hljs-string">`json:"foo,omitempty"`</span>
}

<span class="hljs-comment">// MarkdownViewStatus defines the observed state of MarkdownView</span>
<span class="hljs-keyword">type</span> MarkdownViewStatus <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span>
    <span class="hljs-comment">// Important: Run "make" to regenerate code after modifying this file</span>
}

<span class="hljs-comment">// +kubebuilder:object:root=true</span>
<span class="hljs-comment">// +kubebuilder:subresource:status</span>

<span class="hljs-comment">// MarkdownView is the Schema for the markdownviews API</span>
<span class="hljs-keyword">type</span> MarkdownView <span class="hljs-keyword">struct</span> {
    metav1.TypeMeta   <span class="hljs-string">`json:",inline"`</span>
    metav1.ObjectMeta <span class="hljs-string">`json:"metadata,omitempty"`</span>

    Spec   MarkdownViewSpec   <span class="hljs-string">`json:"spec,omitempty"`</span>
    Status MarkdownViewStatus <span class="hljs-string">`json:"status,omitempty"`</span>
}

<span class="hljs-comment">// +kubebuilder:object:root=true</span>

<span class="hljs-comment">// MarkdownViewList contains a list of MarkdownView</span>
<span class="hljs-keyword">type</span> MarkdownViewList <span class="hljs-keyword">struct</span> {
    metav1.TypeMeta <span class="hljs-string">`json:",inline"`</span>
    metav1.ListMeta <span class="hljs-string">`json:"metadata,omitempty"`</span>
    Items           []MarkdownView <span class="hljs-string">`json:"items"`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
    SchemeBuilder.Register(&amp;MarkdownView{}, &amp;MarkdownViewList{})
}
</code></pre>
<p><code>MarkdownViewSpec</code>, <code>MarkdownViewStatus</code>, <code>MarkdownView</code>, <code>MarkdownViewList</code>という構造体が定義されており、<code>//+kubebuilder:</code>から始まるマーカーコメントがいくつか付与されています。
controller-genは、これらの構造体とマーカーを頼りにCRDの生成をおこないます。</p>
<p><code>MarkdownView</code>がカスタムリソースの本体となる構造体です。<code>MarkdownViewList</code>は<code>MarkdownView</code>のリストを表す構造体です。これら2つの構造体は基本的に変更することはありません。
<code>MarkdownViewSpec</code>と<code>MarkdownViewStatus</code>は<code>MarkdownView</code>構造体を構成する要素です。この2つの構造体を書き換えてカスタムリソースを定義していきます。</p>
<p>一般的にカスタムリソースの<code>Spec</code>はユーザーが記述するもので、システムのあるべき状態をユーザーからコントローラーに伝える用途として利用されます。
一方の<code>Status</code>は、コントローラーが処理した結果をユーザーや他のシステムに伝える用途として利用されます。</p>
<p>なお、CRDを利用してKubernetes APIを拡張する際には、以下の規約に従うことが推奨されています。一度目を通しておくとよいでしょう。</p>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md" target="_blank">Kubernetes API Conventions</a></li>
</ul>
<h2 id="markdownviewspec">MarkdownViewSpec</h2>
<p>さっそく<code>MarkdownViewSpec</code>を書き換えていきましょう。</p>
<p><a href="../introduction/sample.html">作成するカスタムコントローラ</a>において、MarkdownViewコントローラーが扱うカスタムリソースとして下記のようなマニフェストを例示しました。</p>
<blockquote>
<p><a id="view_v1_markdownview.yaml" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/20_manifests/config/samples/view_v1_markdownview.yaml" target="_blank">view_v1_markdownview.yaml</a></p>
</blockquote>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">view.zoetrope.github.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">MarkdownView</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">markdown-view</span>
    <span class="hljs-attr">app.kubernetes.io/managed-by:</span> <span class="hljs-string">kustomize</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">markdownview-sample</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">markdowns:</span>
    <span class="hljs-attr">SUMMARY.md:</span> <span class="hljs-string">|
      # Summary
</span>
      <span class="hljs-bullet">-</span> [<span class="hljs-string">Page1</span>]<span class="hljs-string">(page1.md)</span>
    <span class="hljs-attr">page1.md:</span> <span class="hljs-string">|
      # Page 1
</span>
      <span class="hljs-string">一ページ目のコンテンツです。</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">viewerImage:</span> <span class="hljs-string">"peaceiris/mdbook:latest"</span>
</code></pre>
<p>上記のマニフェストを扱うための構造体を用意しましょう。</p>
<blockquote>
<p><a id="markdownview_types.go" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/20_manifests/api/v1/markdownview_types.go" target="_blank">markdownview_types.go</a></p>
</blockquote>
<pre><code class="lang-golang"><span class="hljs-comment">// MarkdownViewSpec defines the desired state of MarkdownView</span>
<span class="hljs-keyword">type</span> MarkdownViewSpec <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
    <span class="hljs-comment">// Important: Run "make" to regenerate code after modifying this file</span>

    <span class="hljs-comment">// Markdowns contain the markdown files you want to display.</span>
    <span class="hljs-comment">// The key indicates the file name and must not overlap with the keys.</span>
    <span class="hljs-comment">// The value is the content in markdown format.</span>
    <span class="hljs-comment">//+kubebuilder:validation:Required</span>
    <span class="hljs-comment">//+kubebuilder:validation:MinProperties=1</span>
    Markdowns <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> <span class="hljs-string">`json:"markdowns,omitempty"`</span>

    <span class="hljs-comment">// Replicas is the number of viewers.</span>
    <span class="hljs-comment">// +kubebuilder:default=1</span>
    <span class="hljs-comment">// +optional</span>
    Replicas <span class="hljs-type">int32</span> <span class="hljs-string">`json:"replicas,omitempty"`</span>

    <span class="hljs-comment">// ViewerImage is the image name of the viewer.</span>
    <span class="hljs-comment">// +optional</span>
    ViewerImage <span class="hljs-type">string</span> <span class="hljs-string">`json:"viewerImage,omitempty"`</span>
}
</code></pre>
<p>まず下記の3つのフィールドを定義します。</p>
<ul>
<li><code>Markdowns</code>: 表示したいマークダウンファイルの一覧</li>
<li><code>Replicas</code>: Viewerのレプリカ数</li>
<li><code>ViewerImage</code>: Markdownの表示に利用するViewerのイメージ名</li>
</ul>
<p>各フィールドの上に<code>// +kubebuilder</code>という文字列から始まるマーカーと呼ばれるコメントが記述されています。
これらのマーカーによって、生成されるCRDの内容を制御できます。</p>
<p>付与できるマーカーは<code>controller-gen crd -w</code>コマンドで確認できます。</p>
<h3 id="requiredoptional">Required/Optional</h3>
<p><code>Markdowns</code>フィールドには<code>+kubebuiler:validation:Required</code>マーカーが付与されています。
これはこのフィールドが必須項目であることを示しており、ユーザーがマニフェストを記述する際にこの項目を省略できません。
一方の<code>Replicas</code>と<code>ViewerImage</code>には<code>+optional</code>が付与されており、この項目が省略可能であることを示しています。</p>
<p>マーカーを指定しなかった場合はデフォルトでRequiredなフィールドになります。</p>
<p>なお、ファイル内に下記のマーカーを配置すると、デフォルトの挙動をOptionalに変更できます。</p>
<pre><code>// +kubebuilder:validation:Optional
</code></pre><p><code>+optional</code>マーカーを付与しなくても、フィールドの後ろのJSONタグに<code>omitempty</code>を付与した場合は、自動的にOptionalなフィールドとなります。</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> SampleSpec <span class="hljs-keyword">struct</span> {
    Value <span class="hljs-type">string</span> <span class="hljs-string">`json:"value,omitempty"`</span>
}
</code></pre>
<p>Optionalなフィールドは、以下のようにフィールドの型をポインタにできます。
これによりマニフェストで値を指定しなかった場合の挙動が異なります。
ポインタ型にした場合はnullが入り、実体にした場合はその型の初期値(intの場合は0)が入ります。</p>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> SampleSpec <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// +optional</span>
    Value1 <span class="hljs-type">int</span>  <span class="hljs-string">`json:"value1"`</span>
    <span class="hljs-comment">// +optional</span>
    Value2 *<span class="hljs-type">int</span> <span class="hljs-string">`json:"value2"`</span>
}
</code></pre>
<h3 id="validation">Validation</h3>
<p>Kubebuilderには<code>Required</code>以外にも様々なバリデーションが用意されています。
詳しくは<code>controller-gen crd -w</code>コマンドで確認してください。</p>
<ul>
<li>リストの最小要素数、最大要素数</li>
<li>文字列の最小長、最大長</li>
<li>数値の最小値、最大値</li>
<li>正規表現にマッチするかどうか</li>
<li>リスト内の要素がユニークかどうか</li>
</ul>
<h2 id="markdownviewstatus">MarkdownViewStatus</h2>
<p>次にMarkdownViewリソースの状態を表現するための<code>MarkdownViewStatus</code>を書き換えます。</p>
<blockquote>
<p><a id="markdownview_types.go" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/20_manifests/api/v1/markdownview_types.go" target="_blank">markdownview_types.go</a></p>
</blockquote>
<pre><code class="lang-golang"><span class="hljs-comment">// MarkdownViewStatus defines the observed state of MarkdownView</span>
<span class="hljs-keyword">type</span> MarkdownViewStatus <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// Conditions represent the latest available observations of an object's state</span>
    <span class="hljs-comment">// +listType=map</span>
    <span class="hljs-comment">// +listMapKey=type</span>
    <span class="hljs-comment">// +optional</span>
    Conditions []metav1.Condition <span class="hljs-string">`json:"conditions,omitempty"`</span>
}

<span class="hljs-keyword">const</span> (
    TypeMarkdownViewAvailable = <span class="hljs-string">"Available"</span>
    TypeMarkdownViewDegraded  = <span class="hljs-string">"Degraded"</span>
)
</code></pre>
<p>カスタムリソースの状態を表現するには、<a href="https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1" target="_blank"><code>metav1.Condition</code></a>を利用することが一般的です。
今回のカスタムコントローラーでは、ConditionのTypeとして<code>Available</code>,<code>Degraded</code>の3つの状態を表現できるようにしました。</p>
<ul>
<li>Available: レンダリングされたMarkdownが閲覧可能な状態</li>
<li>Degraded: Reconcile処理に失敗した状態</li>
</ul>
<h2 id="markdownview">MarkdownView</h2>
<p>続いて<code>MarkdownView</code>構造体のマーカーを見てみましょう。</p>
<blockquote>
<p><a id="markdownview_types.go" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/20_manifests/api/v1/markdownview_types.go" target="_blank">markdownview_types.go</a></p>
</blockquote>
<pre><code class="lang-golang"><span class="hljs-comment">// +kubebuilder:object:root=true</span>
<span class="hljs-comment">// +kubebuilder:subresource:status</span>
<span class="hljs-comment">// +kubebuilder:printcolumn:name="Replicas",type="integer",JSONPath=".spec.replicas"</span>
<span class="hljs-comment">// +kubebuilder:printcolumn:name="Available",type="string",JSONPath=".status.conditions[?(@.type==\"Available\")].status"</span>

<span class="hljs-comment">// MarkdownView is the Schema for the markdownviews API</span>
<span class="hljs-keyword">type</span> MarkdownView <span class="hljs-keyword">struct</span> {
    metav1.TypeMeta   <span class="hljs-string">`json:",inline"`</span>
    metav1.ObjectMeta <span class="hljs-string">`json:"metadata,omitempty"`</span>

    Spec   MarkdownViewSpec   <span class="hljs-string">`json:"spec,omitempty"`</span>
    Status MarkdownViewStatus <span class="hljs-string">`json:"status,omitempty"`</span>
}
</code></pre>
<p>Kubebuilderが生成した初期状態では、<code>+kubebuilder:object:root=true</code>と<code>+kubebuilder:subresource</code>の2つのマーカーが指定されています。
ここではさらに<code>+kubebuilder:printcolumn</code>を追加することとします。</p>
<p><code>+kubebuilder:object:root=true</code>は、<code>MarkdownView</code>構造体がカスタムリソースのrootオブジェクトであることを表すマーカーです。</p>
<p><code>+kubebuilder:subresource</code>と<code>+kubebuilder:printcolumn</code>マーカーについて、以降で解説します。</p>
<h3 id="subresource">subresource</h3>
<p><code>+kubebuilder:subresource:status</code>というマーカーを追加すると、<code>status</code>フィールドがサブリソースとして扱われるようになります。</p>
<p>Kubernetesでは、すべてのリソースはそれぞれ独立したAPIエンドポイントを持っており、APIサーバー経由でリソースの取得・作成・変更・削除をおこなうことができます。</p>
<p>サブリソースを有効にすると<code>status</code>フィールドがメインのリソースと独立したAPIエンドポイントを持つようになります。</p>
<p>これによりメインのリソース全体を取得・更新しなくても、<code>status</code>のみの取得や更新が可能になります。
ただし、あくまでもメインのリソースに属するサブのリソースなので、個別の作成や削除はできません。</p>
<p>ユーザーが<code>spec</code>フィールドを記述し、コントローラーが<code>status</code>フィールドを記述するという役割分担を明確にできるので、基本的には<code>status</code>はサブリソースにしておくのがよいでしょう。
なおKubebuilder v3では、<code>status</code>フィールドがサブリソースに指定するマーカーが最初から指定されるようになりました。</p>
<p>CRDでは任意のフィールドをサブリソースにはできず、<code>status</code>と<code>scale</code>の2つのフィールドのみに対応しています。</p>
<h3 id="printcolumn">printcolumn</h3>
<p><code>+kubebuilder:printcolumn</code>マーカーを付与すると、kubectlでカスタムリソースを取得したときに表示する項目を指定できます。</p>
<p>表示対象のフィールドはJSONPathで指定可能です。
例えば、<code>JSONPath=".spec.replicas"</code>と記述すると、kubectl getしたときに<code>.spec.replicas</code>の値が表示されます。</p>
<p>kubectlでMarkdownViewリソースを取得すると、下記のようにREPLICASやSTATUSの値が表示されていることが確認できます。</p>
<pre><code>$ kubectl get markdownview
NAME                  REPLICAS   AVAILABLE
MarkdownView-sample   1
</code></pre><h2 id="crdマニフェストの生成">CRDマニフェストの生成</h2>
<p>最後にGoで記述したstructからCRDを生成してみましょう。</p>
<p>以下のコマンドを実行してください。</p>
<pre><code class="lang-console"><span class="hljs-meta prompt_">$ </span><span class="language-bash">make manifests</span>
</code></pre>
<p>すると、以下のようなCRDのマニフェストファイルが生成されます。</p>
<blockquote>
<p><a id="view.zoetrope.github.io_markdownviews.yaml" href="https://github.com/zoetrope/kubebuilder-training/blob/master/docs/kubebuilder/../../codes/20_manifests/config/crd/bases/view.zoetrope.github.io_markdownviews.yaml" target="_blank">view.zoetrope.github.io_markdownviews.yaml</a></p>
</blockquote>
<pre><code class="lang-yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">controller-gen.kubebuilder.io/version:</span> <span class="hljs-string">v0.15.0</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">markdownviews.view.zoetrope.github.io</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">group:</span> <span class="hljs-string">view.zoetrope.github.io</span>
  <span class="hljs-attr">names:</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">MarkdownView</span>
    <span class="hljs-attr">listKind:</span> <span class="hljs-string">MarkdownViewList</span>
    <span class="hljs-attr">plural:</span> <span class="hljs-string">markdownviews</span>
    <span class="hljs-attr">singular:</span> <span class="hljs-string">markdownview</span>
  <span class="hljs-attr">scope:</span> <span class="hljs-string">Namespaced</span>
  <span class="hljs-attr">versions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">additionalPrinterColumns:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">jsonPath:</span> <span class="hljs-string">.spec.replicas</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Replicas</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">jsonPath:</span> <span class="hljs-string">.status.conditions[?(@.type=="Available")].status</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Available</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">schema:</span>
      <span class="hljs-attr">openAPIV3Schema:</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">MarkdownView</span> <span class="hljs-string">is</span> <span class="hljs-string">the</span> <span class="hljs-string">Schema</span> <span class="hljs-string">for</span> <span class="hljs-string">the</span> <span class="hljs-string">markdownviews</span> <span class="hljs-string">API</span>
        <span class="hljs-attr">properties:</span>
          <span class="hljs-attr">apiVersion:</span>
            <span class="hljs-attr">description:</span> <span class="hljs-string">|-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
</span>            <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
          <span class="hljs-attr">kind:</span>
            <span class="hljs-attr">description:</span> <span class="hljs-string">|-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
</span>            <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
          <span class="hljs-attr">metadata:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">spec:</span>
            <span class="hljs-attr">description:</span> <span class="hljs-string">MarkdownViewSpec</span> <span class="hljs-string">defines</span> <span class="hljs-string">the</span> <span class="hljs-string">desired</span> <span class="hljs-string">state</span> <span class="hljs-string">of</span> <span class="hljs-string">MarkdownView</span>
            <span class="hljs-attr">properties:</span>
              <span class="hljs-attr">markdowns:</span>
                <span class="hljs-attr">additionalProperties:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                  Markdowns contain the markdown files you want to display.
                  The key indicates the file name and must not overlap with the keys.
                  The value is the content in markdown format.
</span>                <span class="hljs-attr">minProperties:</span> <span class="hljs-number">1</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">replicas:</span>
                <span class="hljs-attr">default:</span> <span class="hljs-number">1</span>
                <span class="hljs-attr">description:</span> <span class="hljs-string">Replicas</span> <span class="hljs-string">is</span> <span class="hljs-string">the</span> <span class="hljs-string">number</span> <span class="hljs-string">of</span> <span class="hljs-string">viewers.</span>
                <span class="hljs-attr">format:</span> <span class="hljs-string">int32</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
              <span class="hljs-attr">viewerImage:</span>
                <span class="hljs-attr">description:</span> <span class="hljs-string">ViewerImage</span> <span class="hljs-string">is</span> <span class="hljs-string">the</span> <span class="hljs-string">image</span> <span class="hljs-string">name</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">viewer.</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">status:</span>
            <span class="hljs-attr">description:</span> <span class="hljs-string">MarkdownViewStatus</span> <span class="hljs-string">defines</span> <span class="hljs-string">the</span> <span class="hljs-string">observed</span> <span class="hljs-string">state</span> <span class="hljs-string">of</span> <span class="hljs-string">MarkdownView</span>
            <span class="hljs-attr">properties:</span>
              <span class="hljs-attr">conditions:</span>
                <span class="hljs-attr">description:</span> <span class="hljs-string">Conditions</span> <span class="hljs-string">represent</span> <span class="hljs-string">the</span> <span class="hljs-string">latest</span> <span class="hljs-string">available</span> <span class="hljs-string">observations</span>
                  <span class="hljs-string">of</span> <span class="hljs-string">an</span> <span class="hljs-string">object's</span> <span class="hljs-string">state</span>
                <span class="hljs-attr">items:</span>
                  <span class="hljs-attr">description:</span> <span class="hljs-string">"Condition contains details for one aspect of the current
                    state of this API Resource.\n---\nThis struct is intended for
                    direct use as an array at the field path .status.conditions.  For
                    example,\n\n\n\ttype FooStatus struct{\n\t    // Represents the
                    observations of a foo's current state.\n\t    // Known .status.conditions.type
                    are: \"Available\", \"Progressing\", and \"Degraded\"\n\t    //
                    +patchMergeKey=type\n\t    // +patchStrategy=merge\n\t    // +listType=map\n\t
                    \   // +listMapKey=type\n\t    Conditions []metav1.Condition `json:\"conditions,omitempty\"
                    patchStrategy:\"merge\" patchMergeKey:\"type\" protobuf:\"bytes,1,rep,name=conditions\"`\n\n\n\t
                    \   // other fields\n\t}"</span>
                  <span class="hljs-attr">properties:</span>
                    <span class="hljs-attr">lastTransitionTime:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
</span>                      <span class="hljs-attr">format:</span> <span class="hljs-string">date-time</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">message:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
</span>                      <span class="hljs-attr">maxLength:</span> <span class="hljs-number">32768</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">observedGeneration:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
</span>                      <span class="hljs-attr">format:</span> <span class="hljs-string">int64</span>
                      <span class="hljs-attr">minimum:</span> <span class="hljs-number">0</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">integer</span>
                    <span class="hljs-attr">reason:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
</span>                      <span class="hljs-attr">maxLength:</span> <span class="hljs-number">1024</span>
                      <span class="hljs-attr">minLength:</span> <span class="hljs-number">1</span>
                      <span class="hljs-attr">pattern:</span> <span class="hljs-string">^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">status:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">status</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">condition,</span> <span class="hljs-string">one</span> <span class="hljs-string">of</span> <span class="hljs-literal">True</span><span class="hljs-string">,</span> <span class="hljs-literal">False</span><span class="hljs-string">,</span> <span class="hljs-string">Unknown.</span>
                      <span class="hljs-attr">enum:</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">"True"</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">"False"</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">Unknown</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">type:</span>
                      <span class="hljs-attr">description:</span> <span class="hljs-string">|-
                        type of condition in CamelCase or in foo.example.com/CamelCase.
                        ---
                        Many .condition.type values are consistent across resources like Available, but because arbitrary conditions can be
                        useful (see .node.status.conditions), the ability to deconflict is important.
                        The regex it matches is (dns1123SubdomainFmt/)?(qualifiedNameFmt)
</span>                      <span class="hljs-attr">maxLength:</span> <span class="hljs-number">316</span>
                      <span class="hljs-attr">pattern:</span> <span class="hljs-string">^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                  <span class="hljs-attr">required:</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">lastTransitionTime</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">message</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">reason</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">status</span>
                  <span class="hljs-bullet">-</span> <span class="hljs-string">type</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
                <span class="hljs-attr">x-kubernetes-list-map-keys:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">type</span>
                <span class="hljs-attr">x-kubernetes-list-type:</span> <span class="hljs-string">map</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
    <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">subresources:</span>
      <span class="hljs-attr">status:</span> {}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: controller-tools">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="rbac.html" class="navigation navigation-next " aria-label="Next page: RBACマニフェストの生成">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CRDマニフェストの生成","level":"1.3.1","depth":2,"next":{"title":"RBACマニフェストの生成","level":"1.3.2","depth":2,"path":"controller-tools/rbac.md","ref":"controller-tools/rbac.md","articles":[]},"previous":{"title":"controller-tools","level":"1.3","depth":1,"path":"controller-tools/README.md","ref":"controller-tools/README.md","articles":[{"title":"CRDマニフェストの生成","level":"1.3.1","depth":2,"path":"controller-tools/crd.md","ref":"controller-tools/crd.md","articles":[]},{"title":"RBACマニフェストの生成","level":"1.3.2","depth":2,"path":"controller-tools/rbac.md","ref":"controller-tools/rbac.md","articles":[]},{"title":"Webhookマニフェストの生成","level":"1.3.3","depth":2,"path":"controller-tools/webhook.md","ref":"controller-tools/webhook.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["include-codeblock"],"root":"./docs","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"include-codeblock":{"check":false,"edit":false,"lang":"","fixlang":false,"template":"/home/zoetrope/repos/github.com/zoetrope/kubebuilder-training/template.hbs","theme":"chrome","unindent":false},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"つくって学ぶKubebuilder","gitbook":"*"},"file":{"path":"controller-tools/crd.md","mtime":"2024-08-18T13:55:49.904Z","type":"markdown"},"gitbook":{"version":"5.1.4","time":"2024-08-18T14:15:30.407Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

